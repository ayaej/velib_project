version: '3.8'

services:
  # MongoDB Primary (Node 1)
  mongo:
    image: mongo:6
    container_name: velib_mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
    volumes:
      - mongo_data:/data/db
    networks:
      - velib_network
    restart: unless-stopped

  # MongoDB Secondary (Node 2)
  mongo-replica-2:
    image: mongo:6
    container_name: velib_mongodb_replica2
    ports:
      - "27018:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
    volumes:
      - mongo_replica2_data:/data/db
    networks:
      - velib_network
    depends_on:
      - mongo
    restart: unless-stopped

  # HDFS NameNode
  namenode:
    image: bde2020/hadoop-namenode:2.0.0-hadoop3.2.1-java8
    container_name: velib_namenode
    ports:
      - "9870:9870"   # Web UI
      - "8020:8020"   # NameNode service
    env_file:
      - ./hadoop.env
    environment:
      CORE_CONF_fs_defaultFS: hdfs://namenode:8020
    volumes:
      - namenode_data:/hadoop/dfs/name
      - ../hadoop/core-site.xml:/opt/hadoop/etc/hadoop/core-site.xml:ro
      - ../hadoop/hdfs-site.xml:/opt/hadoop/etc/hadoop/hdfs-site.xml:ro
    networks:
      - velib_network
    restart: unless-stopped

  # HDFS DataNode
  datanode:
    image: bde2020/hadoop-datanode:2.0.0-hadoop3.2.1-java8
    container_name: velib_datanode
    ports:
      - "9864:9864"   # DataNode web UI
    env_file:
      - ./hadoop.env
    environment:
      CORE_CONF_fs_defaultFS: hdfs://namenode:8020
    volumes:
      - datanode_data:/hadoop/dfs/data
      - ../hadoop/core-site.xml:/opt/hadoop/etc/hadoop/core-site.xml:ro
      - ../hadoop/hdfs-site.xml:/opt/hadoop/etc/hadoop/hdfs-site.xml:ro
    networks:
      - velib_network
    depends_on:
      - namenode
    restart: unless-stopped

  # Apache Spark Master pour le streaming et batch
  spark-master:
    image: apache/spark:3.5.0
    container_name: velib_spark_master
    command: /opt/spark/bin/spark-class org.apache.spark.deploy.master.Master
    environment:
      - SPARK_MASTER_HOST=spark-master
      - SPARK_MASTER_PORT=7077
      - SPARK_MASTER_WEBUI_PORT=8080
    ports:
      - "8082:8080"
      - "7077:7077"
      - "4040:4040"
    volumes:
      - ../streaming:/opt/spark-apps/streaming
      - ../batch:/opt/spark-apps/batch
    networks:
      - velib_network
    depends_on:
      - mongo
      - namenode
    restart: unless-stopped

  # Spark Worker
  spark-worker:
    image: apache/spark:3.5.0
    container_name: velib_spark_worker
    command: /opt/spark/bin/spark-class org.apache.spark.deploy.worker.Worker spark://spark-master:7077
    environment:
      - SPARK_MASTER=spark://spark-master:7077
      - SPARK_WORKER_CORES=2
      - SPARK_WORKER_MEMORY=2G
    ports:
      - "8083:8081"
    networks:
      - velib_network
    depends_on:
      - spark-master
    restart: unless-stopped

  # Backend Node.js + Express
  backend:
    build: ../backend
    container_name: velib_backend
    ports:
      - "3001:3000"
    environment:
      - NODE_ENV=development
      - MONGODB_URI=mongodb://admin:admin123@mongo:27017/velib_db?authSource=admin
      - PORT=3000
    volumes:
      - ../backend:/app
      - /app/node_modules
    networks:
      - velib_network
    depends_on:
      - mongo
      - mongo-replica-2
    restart: unless-stopped

networks:
  velib_network:
    driver: bridge

volumes:
  mongo_data:
  mongo_replica2_data:
  namenode_data:
  datanode_data:
